// ========================================
// DONULAND MANAGEMENT SYSTEM - MAIN APP
// Hlavn√≠ soubor aplikace - inicializace a koordinace
// ========================================

// Glob√°ln√≠ inicializace aplikace
document.addEventListener('DOMContentLoaded', function() {
    debug('üöÄ Spou≈°t√≠m Donuland Management System...');
    
    // Robustnƒõj≈°√≠ inicializace s retry mechanismem
    initializeAppWithRetry();
});

// Hlavn√≠ inicializaƒçn√≠ funkce s retry
async function initializeAppWithRetry(attempt = 1, maxAttempts = 3) {
    debug(`üì± Inicializuji aplikaci (pokus ${attempt}/${maxAttempts})...`);
    
    try {
        // Kontrola, ≈æe v≈°echny pot≈ôebn√© moduly jsou naƒçten√©
        const moduleCheck = checkRequiredModules();
        
        if (!moduleCheck.allLoaded && attempt < maxAttempts) {
            console.warn(`‚ö†Ô∏è Chyb√≠ moduly: ${moduleCheck.missing.join(', ')}. Zkou≈°√≠m znovu za 1s...`);
            setTimeout(() => {
                initializeAppWithRetry(attempt + 1, maxAttempts);
            }, 1000);
            return;
        }
        
        if (!moduleCheck.allLoaded) {
            throw new Error(`Kritick√© moduly nenaƒçten√©: ${moduleCheck.missing.join(', ')}`);
        }
        
        // Postupn√° inicializace s error handling
        await initializeApp();
        
    } catch (error) {
        debugError('‚ùå Kritick√° chyba p≈ôi inicializaci aplikace:', error);
        
        if (attempt < maxAttempts) {
            console.warn(`‚ö†Ô∏è Zkou≈°√≠m reinicializaci za 2s (pokus ${attempt + 1}/${maxAttempts})`);
            setTimeout(() => {
                initializeAppWithRetry(attempt + 1, maxAttempts);
            }, 2000);
        } else {
            showCriticalError(error);
        }
    }
}

// Kontrola naƒçten√Ωch modul≈Ø
function checkRequiredModules() {
    const requiredModules = [
        { name: 'CONFIG', obj: window.CONFIG },
        { name: 'utils', obj: window.utils },
        { name: 'ui', obj: window.ui },
        { name: 'dataManager', obj: window.dataManager },
        { name: 'predictor', obj: window.predictor },
        { name: 'analysis', obj: window.analysis },
        { name: 'weatherService', obj: window.weatherService },
        { name: 'mapsService', obj: window.mapsService },
        { name: 'navigation', obj: window.navigation },
        { name: 'settings', obj: window.settings }
    ];
    
    const missing = [];
    
    for (const module of requiredModules) {
        if (typeof module.obj === 'undefined') {
            missing.push(module.name);
        }
    }
    
    return {
        allLoaded: missing.length === 0,
        missing: missing,
        loaded: requiredModules.length - missing.length,
        total: requiredModules.length
    };
}

// Hlavn√≠ inicializaƒçn√≠ funkce
async function initializeApp() {
    debug('üì± Inicializuji aplikaci...');
    
    try {
        // 1. Naƒçten√≠ a aplikace nastaven√≠
        await safeModuleCall('settings.loadSettings', () => {
            if (typeof settings !== 'undefined' && typeof settings.loadSettings === 'function') {
                settings.loadSettings();
                return true;
            }
            return false;
        });
        
        // 2. Inicializace navigace
        await safeModuleCall('navigation.init', () => {
            if (typeof navigation !== 'undefined' && typeof navigation.init === 'function') {
                navigation.init();
                return true;
            }
            return false;
        });
        
        // 3. Nastaven√≠ event listener≈Ø
        setupEventListeners();
        
        // 4. Poƒç√°teƒçn√≠ naƒçten√≠ dat (non-blocking)
        performInitialDataLoad().catch(error => {
            debugWarn('‚ö†Ô∏è Poƒç√°teƒçn√≠ naƒçten√≠ dat selhalo:', error);
        });
        
        // 5. Finalizace UI
        finalizeInitialization();
        
        debug('‚úÖ Aplikace √∫spƒõ≈°nƒõ inicializov√°na');
        
    } catch (error) {
        debugError('‚ùå Chyba p≈ôi inicializaci aplikace:', error);
        throw error;
    }
}

// Bezpeƒçn√© vol√°n√≠ modul≈Ø
async function safeModuleCall(moduleName, moduleFunction) {
    try {
        const result = await moduleFunction();
        if (result !== false) {
            debug(`‚úÖ ${moduleName} - √∫spƒõ≈°nƒõ inicializov√°n`);
        } else {
            debugWarn(`‚ö†Ô∏è ${moduleName} - modul nen√≠ dostupn√Ω`);
        }
        return result;
    } catch (error) {
        debugError(`‚ùå ${moduleName} - chyba p≈ôi inicializaci:`, error);
        return false;
    }
}

// Nastaven√≠ event listener≈Ø s error handling
function setupEventListeners() {
    debug('üîó Nastavuji event listenery...');
    
    try {
        // Formul√°≈ôov√© prvky pro automatickou aktualizaci predikce
        const formElements = [
            'eventName', 'eventCategory', 'eventCity', 'eventDate',
            'expectedVisitors', 'eventDuration', 'competition', 
            'businessModel', 'rentType', 'donutPrice',
            'fixedRent', 'percentageRent', 'mixedFixed', 'mixedPercentage'
        ];
        
        formElements.forEach(elementId => {
            const element = document.getElementById(elementId);
            if (element) {
                // Debounced predikce pro input ud√°losti
                const debouncedUpdate = utils.debounce(() => {
                    try {
                        if (isFormReadyForPrediction()) {
                            predictor.updatePrediction();
                        }
                    } catch (error) {
                        debugError(`Chyba p≈ôi aktualizaci predikce z ${elementId}:`, error);
                    }
                }, 1000);
                
                element.addEventListener('input', debouncedUpdate);
                element.addEventListener('change', () => {
                    try {
                        if (isFormReadyForPrediction()) {
                            predictor.updatePrediction();
                        }
                    } catch (error) {
                        debugError(`Chyba p≈ôi change predikce z ${elementId}:`, error);
                    }
                });
            }
        });
        
        // Speci√°ln√≠ handlery s error handling
        setupSpecialHandlers();
        
        // Glob√°ln√≠ event listenery
        setupGlobalEventListeners();
        
        debug('‚úÖ Event listenery nastaveny');
        
    } catch (error) {
        debugError('‚ùå Chyba p≈ôi nastavov√°n√≠ event listener≈Ø:', error);
        throw error;
    }
}

// Speci√°ln√≠ handlery pro konkr√©tn√≠ pole
function setupSpecialHandlers() {
    try {
        const cityInput = document.getElementById('eventCity');
        if (cityInput) {
            cityInput.addEventListener('change', () => {
                try {
                    if (typeof predictor !== 'undefined') {
                        predictor.updateDistance();
                        if (document.getElementById('eventDate').value) {
                            predictor.updateWeather();
                        }
                    }
                } catch (error) {
                    debugError('Chyba p≈ôi city change:', error);
                }
            });
        }
        
        const dateInput = document.getElementById('eventDate');
        if (dateInput) {
            dateInput.addEventListener('change', () => {
                try {
                    if (typeof predictor !== 'undefined' && document.getElementById('eventCity').value) {
                        predictor.updateWeather();
                    }
                } catch (error) {
                    debugError('Chyba p≈ôi date change:', error);
                }
            });
        }
        
        const businessModelSelect = document.getElementById('businessModel');
        if (businessModelSelect) {
            businessModelSelect.addEventListener('change', () => {
                try {
                    if (typeof ui !== 'undefined') {
                        ui.updateBusinessModelInfo(businessModelSelect.value);
                        if (isFormReadyForPrediction()) {
                            predictor.updatePrediction();
                        }
                    }
                } catch (error) {
                    debugError('Chyba p≈ôi business model change:', error);
                }
            });
        }
        
        const rentTypeSelect = document.getElementById('rentType');
        if (rentTypeSelect) {
            rentTypeSelect.addEventListener('change', () => {
                try {
                    if (typeof ui !== 'undefined') {
                        ui.updateRentInputs(rentTypeSelect.value);
                        if (isFormReadyForPrediction()) {
                            predictor.updatePrediction();
                        }
                    }
                } catch (error) {
                    debugError('Chyba p≈ôi rent type change:', error);
                }
            });
        }
        
    } catch (error) {
        debugWarn('Chyba p≈ôi nastavov√°n√≠ speci√°ln√≠ch handler≈Ø:', error);
    }
}

// Glob√°ln√≠ event listenery
function setupGlobalEventListeners() {
    try {
        // Window resize handler pro responsive design
        window.addEventListener('resize', utils.debounce(() => {
            try {
                handleWindowResize();
            } catch (error) {
                debugError('Chyba p≈ôi resize:', error);
            }
        }, 250));
        
        // P≈ôed zav≈ôen√≠m str√°nky - ulo≈æen√≠ dat
        window.addEventListener('beforeunload', () => {
            try {
                if (typeof navigation !== 'undefined' && typeof navigation.saveFormData === 'function') {
                    navigation.saveFormData();
                }
            } catch (error) {
                debugError('Chyba p≈ôi ukl√°d√°n√≠ p≈ôed zav≈ôen√≠m:', error);
            }
        });
        
        // Handler pro chyby JavaScriptu
        window.addEventListener('error', (event) => {
            debugError('Neoƒçek√°van√° chyba:', event.error);
            try {
                if (typeof ui !== 'undefined') {
                    ui.showNotification('‚ö†Ô∏è Do≈°lo k neoƒçek√°van√© chybƒõ. Zkuste obnovit str√°nku.', 'warning');
                }
            } catch (uiError) {
                console.error('Chyba p≈ôi zobrazov√°n√≠ error notifikace:', uiError);
            }
        });
        
        // Handler pro unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            debugError('Unhandled promise rejection:', event.reason);
            try {
                if (typeof ui !== 'undefined') {
                    ui.showNotification('‚ö†Ô∏è Do≈°lo k chybƒõ p≈ôi komunikaci se slu≈æbami.', 'warning');
                }
            } catch (uiError) {
                console.error('Chyba p≈ôi zobrazov√°n√≠ promise error notifikace:', uiError);
            }
        });
        
    } catch (error) {
        debugWarn('Chyba p≈ôi nastavov√°n√≠ glob√°ln√≠ch event listener≈Ø:', error);
    }
}

// Poƒç√°teƒçn√≠ naƒçten√≠ dat
async function performInitialDataLoad() {
    debug('üìä Spou≈°t√≠m poƒç√°teƒçn√≠ naƒçten√≠ dat...');
    
    try {
        // Kontrola, zda jsou nastaven√≠ kompletn√≠
        if (typeof settings !== 'undefined' && typeof settings.areSettingsComplete === 'function') {
            if (!settings.areSettingsComplete()) {
                if (typeof ui !== 'undefined') {
                    ui.showNotification('‚ö†Ô∏è Dokonƒçete pros√≠m nastaven√≠ v sekci Nastaven√≠', 'warning');
                }
            }
        }
        
        // Pokus o automatick√© naƒçten√≠ dat z Google Sheets
        if (CONFIG && CONFIG.GOOGLE_SHEETS_URL) {
            debug('üîÑ Pokou≈°√≠m se automaticky naƒç√≠st data...');
            
            try {
                if (typeof dataManager !== 'undefined' && typeof dataManager.loadData === 'function') {
                    await dataManager.loadData();
                    debug('‚úÖ Automatick√© naƒçten√≠ dat √∫spƒõ≈°n√©');
                }
            } catch (error) {
                debugWarn('‚ö†Ô∏è Automatick√© naƒçten√≠ dat selhalo:', error.message);
                // Nen√≠ kritick√©, u≈æivatel m≈Ø≈æe naƒç√≠st data manu√°lnƒõ
            }
        }
        
    } catch (error) {
        debugWarn('‚ö†Ô∏è Chyba p≈ôi poƒç√°teƒçn√≠m naƒçten√≠ dat:', error);
        // Nen√≠ kritick√° chyba, aplikace m≈Ø≈æe fungovat bez dat
    }
}

// Finalizace inicializace
function finalizeInitialization() {
    debug('üéØ Finalizuji inicializaci...');
    
    try {
        // Skryt√≠ loading screen a zobrazen√≠ hlavn√≠ aplikace
        setTimeout(() => {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            if (mainApp) {
                mainApp.style.display = 'block';
            }
            
            // Zobrazen√≠ uv√≠tac√≠ zpr√°vy
            if (typeof ui !== 'undefined') {
                ui.showNotification('üç© Donuland Management System je p≈ôipraven k pou≈æit√≠!', 'success');
            }
            
            // Nastaven√≠ spr√°vn√©ho stavu status indik√°toru
            updateInitialStatusIndicator();
            
        }, 1000);
        
    } catch (error) {
        debugError('Chyba p≈ôi finalizaci:', error);
        // Pokus√≠me se alespo≈à skr√Ωt loading screen
        try {
            const loadingScreen = document.getElementById('loadingScreen');
            const mainApp = document.getElementById('mainApp');
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainApp) mainApp.style.display = 'block';
        } catch (finalError) {
            debugError('Kritick√° chyba p≈ôi finalizaci UI:', finalError);
        }
    }
}

// Aktualizace poƒç√°teƒçn√≠ho status indik√°toru
function updateInitialStatusIndicator() {
    try {
        if (typeof ui !== 'undefined' && globalData && globalData.historicalData) {
            if (globalData.historicalData.length > 0) {
                ui.updateStatusIndicator('online', `${globalData.historicalData.length} z√°znam≈Ø`);
            } else {
                ui.updateStatusIndicator('offline', '≈Ω√°dn√° data');
            }
        }
    } catch (error) {
        debugWarn('Chyba p≈ôi aktualizaci status indik√°toru:', error);
    }
}

// Kontrola, zda je formul√°≈ô p≈ôipraven pro predikci
function isFormReadyForPrediction() {
    try {
        const requiredFields = [
            'eventName', 'eventCategory', 'eventCity', 'eventDate',
            'expectedVisitors', 'competition', 'businessModel', 'rentType'
        ];
        
        return requiredFields.every(fieldId => {
            const element = document.getElementById(fieldId);
            return element && element.value && element.value.trim().length > 0;
        });
    } catch (error) {
        debugError('Chyba p≈ôi kontrole formul√°≈ôe:', error);
        return false;
    }
}

// Handler pro zmƒõnu velikosti okna
function handleWindowResize() {
    try {
        const width = window.innerWidth;
        
        // Mobile/tablet adjustments
        if (width <= 768) {
            // Zajist√≠me, ≈æe sidebar je skryt√Ω na mobilech
            const sidebar = document.querySelector('.sidebar');
            if (sidebar && !sidebar.querySelector('.mobile-menu-toggle')) {
                if (typeof navigation !== 'undefined' && typeof navigation.setupMobileMenu === 'function') {
                    navigation.setupMobileMenu();
                }
            }
        }
        
        debug(`üì± Window resized to: ${width}x${window.innerHeight}`);
    } catch (error) {
        debugError('Chyba p≈ôi resize handling:', error);
    }
}

// Zobrazen√≠ kritick√© chyby
function showCriticalError(error) {
    const errorHTML = `
        <div style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            font-family: 'Segoe UI', sans-serif;
        ">
            <div style="text-align: center; max-width: 500px; padding: 40px;">
                <div style="font-size: 4em; margin-bottom: 20px;">üí•</div>
                <h1 style="margin-bottom: 20px;">Kritick√° chyba aplikace</h1>
                <p style="margin-bottom: 30px; font-size: 1.1em;">
                    Do≈°lo k neoƒçek√°van√© chybƒõ p≈ôi inicializaci aplikace.
                </p>
                <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                    <code style="color: #ffeb3b;">${error.message}</code>
                </div>
                <button onclick="location.reload()" style="
                    background: white;
                    color: #ff6b6b;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 1.1em;
                    font-weight: bold;
                    cursor: pointer;
                ">
                    üîÑ Obnovit str√°nku
                </button>
                <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">
                    Pokud probl√©m p≈ôetrv√°v√°, zkontrolujte konzoli prohl√≠≈æeƒçe (F12)
                </div>
            </div>
        </div>
    `;
    
    document.body.innerHTML = errorHTML;
}

// Glob√°ln√≠ utility funkce dostupn√© v konzoli pro debugging
window.donuland = {
    // Data
    data: () => globalData || {},
    config: () => CONFIG || {},
    
    // Funkce
    loadData: () => {
        try {
            return typeof dataManager !== 'undefined' ? dataManager.loadData() : console.error('dataManager not loaded');
        } catch (error) {
            console.error('Error loading data:', error);
        }
    },
    refreshData: () => {
        try {
            return typeof dataManager !== 'undefined' ? dataManager.refreshData() : console.error('dataManager not loaded');
        } catch (error) {
            console.error('Error refreshing data:', error);
        }
    },
    clearCache: () => {
        try {
            return typeof utils !== 'undefined' ? utils.clearCache() : console.error('utils not loaded');
        } catch (error) {
            console.error('Error clearing cache:', error);
        }
    },
    getStats: () => {
        try {
            return typeof dataManager !== 'undefined' ? dataManager.getDataStats() : console.error('dataManager not loaded');
        } catch (error) {
            console.error('Error getting stats:', error);
        }
    },
    
    // Test funkce
    testWeather: (city, date) => {
        try {
            return typeof weatherService !== 'undefined' ? weatherService.getWeather(city, date) : console.error('weatherService not loaded');
        } catch (error) {
            console.error('Error testing weather:', error);
        }
    },
    testDistance: (from, to) => {
        try {
            return typeof mapsService !== 'undefined' ? mapsService.calculateDistance(from, to) : console.error('mapsService not loaded');
        } catch (error) {
            console.error('Error testing distance:', error);
        }
    },
    testPrediction: () => {
        try {
            return typeof predictor !== 'undefined' ? predictor.updatePrediction() : console.error('predictor not loaded');
        } catch (error) {
            console.error('Error testing prediction:', error);
        }
    },
    
    // Debug funkce
    enableDebug: () => { 
        try {
            if (CONFIG) CONFIG.DEBUG = true; 
            debug('Debug mode enabled'); 
        } catch (error) {
            console.error('Error enabling debug:', error);
        }
    },
    disableDebug: () => { 
        try {
            if (CONFIG) CONFIG.DEBUG = false; 
            console.log('Debug mode disabled'); 
        } catch (error) {
            console.error('Error disabling debug:', error);
        }
    },
    showData: () => {
        try {
            return globalData && globalData.historicalData ? console.table(globalData.historicalData.slice(0, 10)) : console.log('No data available');
        } catch (error) {
            console.error('Error showing data:', error);
        }
    },
    
    // Status check
    checkModules: () => {
        try {
            const moduleCheck = checkRequiredModules();
            console.log(`Naƒçteno ${moduleCheck.loaded}/${moduleCheck.total} modul≈Ø`);
            if (moduleCheck.missing.length > 0) {
                console.warn('Chyb√≠ moduly:', moduleCheck.missing);
            }
            return moduleCheck;
        } catch (error) {
            console.error('Error checking modules:', error);
        }
    },

    // Restart aplikace
    restart: () => {
        try {
            console.log('üîÑ Restartov√°n√≠ aplikace...');
            location.reload();
        } catch (error) {
            console.error('Error restarting app:', error);
        }
    }
};

// Export verz√≠ pro debugging
console.log(`
üç© Donuland Management System
============================
Verze: 1.0.0
Naƒçteno: ${new Date().toLocaleString('cs-CZ')}
Debug: ${CONFIG && CONFIG.DEBUG ? 'Zapnut' : 'Vypnut'}

Dostupn√© funkce v konzoli:
- donuland.loadData() - naƒçten√≠ dat
- donuland.getStats() - statistiky dat
- donuland.testWeather('Praha', '2025-07-01') - test poƒças√≠
- donuland.enableDebug() - zapnut√≠ debug m√≥du
- donuland.showData() - zobrazen√≠ uk√°zky dat
- donuland.checkModules() - kontrola naƒçten√Ωch modul≈Ø
- donuland.restart() - restart aplikace

Pro v√≠ce informac√≠: https://github.com/donuland/management-system
`);

debug('üéâ Donuland Management System p≈ôipraven k pou≈æit√≠!');
